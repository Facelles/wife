<template>
  <div class="space-y-8 max-w-4xl mx-auto px-4">
    <!-- Welcome Section -->
    <div class="text-center animate-slide-down">
      <h1 class="text-4xl sm:text-5xl md:text-6xl font-light text-gray-900 mb-4 hover:text-primary-600 transition-colors duration-300">
        –ö–∏—Ü—é–Ω—è –∑ –∑–∞–π—á–∏–∫–æ–º
      </h1>
      <p class="text-lg sm:text-xl md:text-2xl text-gray-500 hover:text-gray-700 transition-colors duration-300">
        –í–∞—à—ñ —Å–ø—ñ–ª—å–Ω—ñ –º–æ–º–µ–Ω—Ç–∏ üíï
      </p>
    </div>

    <!-- Chat Section -->
    <div class="space-y-4">
      <h2 class="text-2xl md:text-4xl font-light text-gray-700 text-center animate-fade-in">–ß–∞—Ç</h2>
      <div class="bg-white/50 backdrop-blur-sm rounded-2xl p-4 md:p-8 animate-slide-up flex justify-center">
        <router-link to="/chat" class="flex items-center space-x-4 px-4 md:px-6 py-3 bg-primary-100 rounded-xl shadow hover:bg-primary-200 transition-colors">
          <span class="material-icons text-2xl md:text-3xl text-primary-500">chat</span>
          <span class="font-light text-gray-700 text-base md:text-xl">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —á–∞—Ç—É</span>
        </router-link>
      </div>
    </div>

    <!-- Mood Section -->
    <div class="space-y-4">
      <h2 class="text-2xl md:text-4xl font-light text-gray-700 text-center animate-fade-in">–ù–∞—Å—Ç—Ä—ñ–π</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div
          class="bg-white/50 backdrop-blur-sm rounded-2xl p-4 text-center animate-slide-up cursor-pointer hover:shadow-lg transition"
          @click="showMoodSelector = true"
        >
          <h3 class="text-sm md:text-base font-light text-gray-400 mb-2">{{ authStore.user?.email === 'facellesit@gmail.com' ? '–ó–∞–π—á–∏–∫' : '–ö–∏—Ü—é–Ω—è' }}</h3>
          <p class="text-4xl md:text-6xl">{{ currentMood || 'üòê' }}</p>
        </div>
        <div class="bg-white/50 backdrop-blur-sm rounded-2xl p-4 text-center animate-slide-up">
          <h3 class="text-sm md:text-base font-light text-gray-400 mb-2">{{ authStore.user?.email === 'facellesit@gmail.com' ? '–ö–∏—Ü—é–Ω—è' : '–ó–∞–π—á–∏–∫' }}</h3>
          <p class="text-4xl md:text-6xl">{{ partnerMood || 'üòê' }}</p>
        </div>
      </div>
    </div>

    <!-- Photos Section -->
    <div class="space-y-4">
      <h2 class="text-2xl md:text-4xl font-light text-gray-700 text-center animate-fade-in">–°–≤—ñ—Ç–ª–∏–Ω–∏</h2>
      <div class="bg-white/50 backdrop-blur-sm rounded-2xl p-4 md:p-8 animate-slide-up flex justify-center">
        <router-link to="/photos" class="flex items-center space-x-4 px-4 md:px-6 py-3 bg-primary-100 rounded-xl shadow hover:bg-primary-200 transition-colors">
          <span class="material-icons text-2xl md:text-3xl text-primary-500">photo_camera</span>
          <span class="font-light text-gray-700 text-base md:text-xl">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –≥–∞–ª–µ—Ä–µ—ó</span>
        </router-link>
      </div>
    </div>

    <!-- Sleep Section -->
    <div class="space-y-4">
      <h2 class="text-2xl md:text-4xl font-light text-gray-700 text-center animate-fade-in">–°–æ–Ω</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div
          class="bg-white/50 backdrop-blur-sm rounded-2xl p-4 text-center animate-slide-up cursor-pointer hover:shadow-lg transition"
          @click="showSleepSelector = true"
        >
          <h3 class="text-sm md:text-base font-light text-gray-400 mb-2">{{ authStore.user?.email === 'facellesit@gmail.com' ? '–ó–∞–π—á–∏–∫' : '–ö–∏—Ü—é–Ω—è' }}</h3>
          <p class="text-4xl md:text-6xl">{{ currentSleep || 'üò¥' }}</p>
        </div>
        <div class="bg-white/50 backdrop-blur-sm rounded-2xl p-4 text-center animate-slide-up">
          <h3 class="text-sm md:text-base font-light text-gray-400 mb-2">{{ authStore.user?.email === 'facellesit@gmail.com' ? '–ö–∏—Ü—é–Ω—è' : '–ó–∞–π—á–∏–∫' }}</h3>
          <p class="text-4xl md:text-6xl">{{ partnerSleep || 'üò¥' }}</p>
        </div>
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="space-y-4">
      <h2 class="text-2xl md:text-4xl font-light text-gray-700 text-center animate-fade-in">–ó–∞–≤–¥–∞–Ω–Ω—è</h2>
      <div class="bg-white/50 backdrop-blur-sm rounded-2xl p-4 md:p-8 animate-slide-up flex justify-center">
        <router-link to="/tasks" class="flex items-center space-x-4 px-4 md:px-6 py-3 bg-primary-100 rounded-xl shadow hover:bg-primary-200 transition-colors">
          <span class="material-icons text-2xl md:text-3xl text-primary-500">assignment</span>
          <span class="font-light text-gray-700 text-base md:text-xl">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∑–∞–≤–¥–∞–Ω—å</span>
        </router-link>
      </div>
    </div>

    <!-- Points Section -->
    <div class="space-y-4">
      <h2 class="text-2xl md:text-4xl font-light text-gray-700 text-center animate-fade-in">–ë–∞–ª–∏</h2>
      <div class="bg-white/50 backdrop-blur-sm rounded-2xl p-4 md:p-8 animate-slide-up">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
          <div class="text-center md:text-left">
            <h3 class="text-sm md:text-base font-light text-gray-400">{{ authStore.user?.email === 'facellesit@gmail.com' ? '–ó–∞–π—á–∏–∫' : '–ö–∏—Ü—é–Ω—è' }}</h3>
            <p class="text-3xl md:text-5xl font-bold text-primary-600">{{ points }}</p>
          </div>
          <div class="flex gap-2">
            <button
              v-for="action in actions"
              :key="action.text"
              @click="action.action"
              class="p-2 md:p-3 bg-white rounded-xl shadow hover:shadow-md transition-shadow"
            >
              <i class="material-icons text-primary-500">{{ action.icon }}</i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Section -->
    <div class="space-y-4">
      <h2 class="text-2xl md:text-4xl font-light text-gray-700 text-center animate-fade-in">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <div class="bg-white/50 backdrop-blur-sm rounded-2xl p-4 md:p-8 animate-slide-up flex justify-center">
        <router-link to="/stats" class="flex items-center space-x-4 px-4 md:px-6 py-3 bg-primary-100 rounded-xl shadow hover:bg-primary-200 transition-colors">
          <span class="material-icons text-2xl md:text-3xl text-primary-500">bar_chart</span>
          <span class="font-light text-gray-700 text-base md:text-xl">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</span>
        </router-link>
      </div>
    </div>

    <!-- Mood Selector Modal -->
    <div v-if="showMoodSelector" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-sm mx-auto transform transition-all">
        <h3 class="text-xl font-medium text-gray-900 mb-4 text-center">–í–∏–±–µ—Ä—ñ—Ç—å –Ω–∞—Å—Ç—Ä—ñ–π</h3>
        <div class="grid grid-cols-5 gap-3 mb-6">
          <button
            v-for="mood in moods"
            :key="mood.value"
            @click="selectMood(mood.emoji)"
            :class="[
              'p-3 text-3xl rounded-lg transition-colors flex items-center justify-center',
              currentMood === mood.emoji ? 'bg-primary-100 ring-2 ring-primary-500' : 'hover:bg-gray-100'
            ]"
          >
            {{ mood.emoji }}
          </button>
        </div>
        <button
          @click="showMoodSelector = false"
          class="w-full py-2 px-4 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
        >
          –°–∫–∞—Å—É–≤–∞—Ç–∏
        </button>
      </div>
    </div>

    <!-- Sleep Selector Modal -->
    <div v-if="showSleepSelector" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-sm mx-auto transform transition-all">
        <h3 class="text-xl font-medium text-gray-900 mb-4 text-center">–û—Ü—ñ–Ω—ñ—Ç—å —è–∫—ñ—Å—Ç—å —Å–Ω—É</h3>
        <div class="grid grid-cols-5 gap-3 mb-6">
          <button
            v-for="sleep in ['üò¥', 'üòå', 'üòë', 'üò´', 'ü•±']"
            :key="sleep"
            @click="selectSleep(sleep)"
            :class="[
              'p-3 text-3xl rounded-lg transition-colors flex items-center justify-center',
              currentSleep === sleep ? 'bg-primary-100 ring-2 ring-primary-500' : 'hover:bg-gray-100'
            ]"
          >
            {{ sleep }}
          </button>
        </div>
        <button
          @click="showSleepSelector = false"
          class="w-full py-2 px-4 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
        >
          –°–∫–∞—Å—É–≤–∞—Ç–∏
        </button>
      </div>
    </div>

    <!-- Add Points Modal -->
    <div v-if="showAddPointsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl p-4 md:p-6 w-full max-w-md mx-auto transform transition-all">
        <h3 class="text-xl font-medium text-gray-900 mb-4 text-center">–î–æ–¥–∞—Ç–∏ –±–∞–ª–∏</h3>
        <form @submit.prevent="handleAddPoints" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
            <input type="number" v-model="addPointsAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" min="1" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">–û–ø–∏—Å</label>
            <input type="text" v-model="addPointsDescription" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" required>
          </div>
          <div class="flex justify-end space-x-3">
            <button type="button" @click="showAddPointsModal = false" class="btn btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏ –±–∞–ª–∏</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useDevice } from '../composables/useDevice'
import { useAuthStore } from '../stores/auth'
import { listenToData, pushData } from '../firebase/database-service'
import { useRouter } from 'vue-router'

const { isMobile, isDesktop } = useDevice()
const authStore = useAuthStore()
const router = useRouter()

const points = ref(0)
const currentMood = ref(null)
const partnerMood = ref(null)
const currentSleep = ref(null)
const partnerSleep = ref(null)
const showMoodSelector = ref(false)
const showSleepSelector = ref(false)
const showAddPointsModal = ref(false)

const myEmail = computed(() => authStore.user?.email)
const partnerEmail = computed(() =>
  myEmail.value === 'facellesit@gmail.com'
    ? 'martadaniluk4@gmail.com'
    : 'facellesit@gmail.com'
)

// –í–∏–∑–Ω–∞—á–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ –Ω–∞—Å—Ç—Ä–æ—ó
const moods = [
  { value: 'great', emoji: 'üòä' },
  { value: 'good', emoji: 'üôÇ' },
  { value: 'neutral', emoji: 'üòê' },
  { value: 'bad', emoji: 'üòï' },
  { value: 'terrible', emoji: 'üò¢' }
]

// –û–ø—Ü—ñ—ó –¥–ª—è —Å–Ω—É
const sleepOptions = [
  { value: 'perfect', emoji: 'üåü' },
  { value: 'good', emoji: 'üòä' },
  { value: 'normal', emoji: 'üòê' },
  { value: 'bad', emoji: 'üò´' },
  { value: 'awful', emoji: 'üò¥' }
]

// –í–∏–∑–Ω–∞—á–∞—î–º–æ —Å—Ç–∞–Ω–∏ –Ω–∞—Å—Ç—Ä–æ—é —Ç–∞ —Å–Ω—É
const sleepStates = {
  'üò¥': { value: 'great', emoji: 'üò¥' },
  'üòå': { value: 'good', emoji: 'üòå' },
  'üòë': { value: 'neutral', emoji: 'üòë' },
  'üò´': { value: 'bad', emoji: 'üò´' },
  'ü•±': { value: 'terrible', emoji: 'ü•±' }
}

onMounted(() => {
  // –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å—ñ –Ω–∞—Å—Ç—Ä–æ—ó
  listenToData('moodmain', (data) => {
    if (data) {
      // mood –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      const myMoodArr = Object.entries(data[authStore.user.uid] || {})
        .sort((a, b) => b[1].createdAt - a[1].createdAt)
      currentMood.value = myMoodArr.length ? myMoodArr[0][1].emoji || myMoodArr[0][1].mood || null : null
      
      // mood –ø–∞—Ä—Ç–Ω–µ—Ä–∞
      const partnerUid = myEmail.value === 'facellesit@gmail.com' ? Object.keys(data).find(uid => uid !== authStore.user.uid) : Object.keys(data).find(uid => uid !== authStore.user.uid)
      if (partnerUid && data[partnerUid]) {
        const partnerMoodArr = Object.entries(data[partnerUid])
          .sort((a, b) => b[1].createdAt - a[1].createdAt)
        partnerMood.value = partnerMoodArr.length ? partnerMoodArr[0][1].emoji || partnerMoodArr[0][1].mood || null : null
      } else {
        partnerMood.value = null
      }
    }
  })

  // –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å—ñ –∑–∞–ø–∏—Å–∏ —Å–Ω—É
  listenToData('sleepmain', (data) => {
    if (data) {
      // sleep –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      const mySleepArr = Object.entries(data[authStore.user.uid] || {})
        .sort((a, b) => b[1].createdAt - a[1].createdAt)
      currentSleep.value = mySleepArr.length ? mySleepArr[0][1].emoji || mySleepArr[0][1].sleep || null : null
      // sleep –ø–∞—Ä—Ç–Ω–µ—Ä–∞
      const partnerUid = myEmail.value === 'facellesit@gmail.com' ? Object.keys(data).find(uid => uid !== authStore.user.uid) : Object.keys(data).find(uid => uid !== authStore.user.uid)
      if (partnerUid && data[partnerUid]) {
        const partnerSleepArr = Object.entries(data[partnerUid])
          .sort((a, b) => b[1].createdAt - a[1].createdAt)
        partnerSleep.value = partnerSleepArr.length ? partnerSleepArr[0][1].emoji || partnerSleepArr[0][1].sleep || null : null
      } else {
        partnerSleep.value = null
      }
    }
  })
})

// –í–∏–±—ñ—Ä –Ω–∞—Å—Ç—Ä–æ—é
const selectMood = async (mood) => {
  console.log('Setting mood:', mood)
  if (!authStore.user) return
  
  try {
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ moodmain
    await pushData(`moodmain/${authStore.user.uid}`, {
      value: moods.find(m => m.emoji === mood)?.value || 'neutral',
      emoji: mood,
      timestamp: Date.now(),
      userId: authStore.user.uid,
      userEmail: authStore.user.email
    })
    currentMood.value = mood
  } catch (error) {
    console.error('Error setting mood:', error)
  }
}

// –í–∏–±—ñ—Ä —è–∫–æ—Å—Ç—ñ —Å–Ω—É
const selectSleep = async (sleep) => {
  console.log('Setting sleep:', sleep)
  if (!authStore.user) return
  
  try {
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ sleepmain
    await pushData(`sleepmain/${authStore.user.uid}`, {
      value: sleepStates[sleep].value,
      emoji: sleep,
      timestamp: Date.now(),
      userId: authStore.user.uid,
      userEmail: authStore.user.email
    })
    currentSleep.value = sleep
  } catch (error) {
    console.error('Error setting sleep:', error)
  }
}

// –î—ñ—ó
const actions = [
  {
    icon: 'add_circle',
    text: '–î–æ–¥–∞—Ç–∏ –±–∞–ª–∏',
    action: () => showAddPointsModal.value = true
  },
  {
    icon: 'mood',
    text: '–ù–∞—Å—Ç—Ä—ñ–π',
    action: () => showMoodSelector.value = true
  },
  {
    icon: 'bedtime',
    text: '–°–æ–Ω',
    action: () => showSleepSelector.value = true
  },
  {
    icon: 'assignment',
    text: '–ó–∞–≤–¥–∞–Ω–Ω—è',
    action: () => router.push('/tasks')
  },
  {
    icon: 'chat',
    text: '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
    action: () => router.push('/chat')
  },
  {
    icon: 'photo_camera',
    text: '–°–≤—ñ—Ç–ª–∏–Ω–∏',
    action: () => router.push('/photos')
  },
  {
    icon: 'bar_chart',
    text: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
    action: () => router.push('/stats')
  }
]

const desktopFeatures = [
  { icon: 'calendar_today', text: '–ö–∞–ª–µ–Ω–¥–∞—Ä –ø–æ–¥—ñ–π' },
  { icon: 'photo_library', text: '–ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ' },
  { icon: 'playlist_add_check', text: '–†–æ–∑—à–∏—Ä–µ–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è' },
  { icon: 'analytics', text: '–î–µ—Ç–∞–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞' }
]

// –î–æ–¥–∞—î–º–æ –ª–æ–≥—ñ–∫—É –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –±–∞–ª—ñ–≤
const addPointsAmount = ref(1)
const addPointsDescription = ref('')
const handleAddPoints = () => {
  // –¢—É—Ç –º–∞—î –±—É—Ç–∏ –ª–æ–≥—ñ–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –±–∞–ª—ñ–≤ –¥–æ –±–∞–∑–∏ –∞–±–æ —Å—Ç–∞–Ω—É
  // –ù–∞–ø—Ä–∏–∫–ª–∞–¥:
  // points.value += addPointsAmount.value
  // –∞–±–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –º–µ—Ç–æ–¥ –∑ PointsStore
  showAddPointsModal.value = false
  addPointsAmount.value = 1
  addPointsDescription.value = ''
}
</script>

<style scoped>
.animate-fade-in {
  animation: fadeIn 0.5s ease-out;
}

.animate-slide-up {
  animation: slideUp 0.5s ease-out forwards;
  opacity: 0;
}

.animate-slide-down {
  animation: slideDown 0.5s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style> 